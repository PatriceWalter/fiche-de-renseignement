<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiche de Renseignement - AAPPMA Gundershoffen</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: linear-gradient(135deg, #1a472a 0%, #2d5a3d 50%, #3d7a5a 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container { max-width: 600px; margin: 0 auto; }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 25px;
            position: relative;
        }
        .header-logo { font-size: 50px; margin-bottom: 10px; }
        .header-title { font-size: 24px; font-weight: 700; margin-bottom: 5px; }
        .header-subtitle { font-size: 14px; opacity: 0.9; }
        
        .admin-gear {
            position: absolute;
            top: 0;
            right: 0;
            font-size: 24px;
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.3s;
        }
        .admin-gear:hover { opacity: 1; transform: rotate(90deg); }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .page-title {
            font-size: 22px;
            color: #1a472a;
            margin-bottom: 25px;
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 2px solid #e8f5e9;
        }
        
        .form-section-title {
            font-size: 16px;
            font-weight: 700;
            color: #2d5a3d;
            margin: 25px 0 15px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #e8f5e9;
        }
        .form-section-title:first-of-type { margin-top: 0; }
        
        .form-group { margin-bottom: 18px; }
        .form-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
            font-size: 14px;
        }
        .form-group.required label::after { content: " *"; color: #c62828; }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #2d5a3d;
            box-shadow: 0 0 0 3px rgba(45,90,61,0.1);
        }
        .form-group input.prefilled { background: #e8f5e9; border-color: #4caf50; }
        
        .form-row { display: grid; grid-template-columns: 1fr 2fr; gap: 15px; }
        
        .reglement-list { margin-top: 10px; }
        .reglement-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 10px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        .reglement-item.checked { background: #e8f5e9; border-color: #4caf50; }
        .reglement-checkbox { width: 22px; height: 22px; cursor: pointer; }
        .reglement-icon { font-size: 24px; }
        .reglement-name { flex: 1; font-weight: 600; color: #333; }
        .reglement-read-btn {
            padding: 8px 16px;
            background: #e0e0e0;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            cursor: not-allowed;
            transition: all 0.3s;
        }
        .reglement-read-btn:not(:disabled) { background: #2d5a3d; color: white; cursor: pointer; }
        .reglement-read-btn:not(:disabled):hover { background: #1a472a; }
        .reglement-status { font-size: 12px; padding: 4px 10px; border-radius: 20px; font-weight: 600; }
        .reglement-status.read { background: #e8f5e9; color: #2e7d32; }
        .reglement-status.unread { background: #ffebee; color: #c62828; }
        
        .btn-submit {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #2d5a3d 0%, #4a8c5c 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 25px;
            transition: all 0.3s;
        }
        .btn-submit:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(45,90,61,0.3); }
        .btn-submit:disabled { background: #ccc; cursor: not-allowed; }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-overlay.visible { display: flex; }
        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 700px;
            width: 100%;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            background: linear-gradient(135deg, #2d5a3d 0%, #4a8c5c 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 { font-size: 18px; }
        .modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
        }
        
        .modal-progress-container { background: #f5f5f5; padding: 10px 20px; border-bottom: 1px solid #e0e0e0; }
        .modal-progress-bar-bg { background: #e0e0e0; border-radius: 10px; height: 8px; overflow: hidden; margin-bottom: 8px; }
        .modal-progress-bar { background: linear-gradient(90deg, #4caf50, #2e7d32); height: 100%; width: 0%; transition: width 0.3s ease; border-radius: 10px; }
        .modal-progress-status { font-size: 12px; color: #666; text-align: center; }
        .modal-progress-status.complete { color: #2e7d32; font-weight: 600; }
        
        .modal-body { padding: 25px; overflow-y: auto; flex: 1; font-size: 14px; line-height: 1.7; }
        .modal-body h3 { color: #1a472a; margin: 20px 0 10px; font-size: 16px; }
        .modal-body h3:first-child { margin-top: 0; }
        .modal-body ul { margin-left: 20px; margin-bottom: 15px; }
        .modal-body li { margin-bottom: 5px; }
        .modal-body .important { background: #fff3e0; padding: 15px; border-radius: 10px; border-left: 4px solid #ff9800; margin: 15px 0; }
        .modal-body .warning { background: #ffebee; padding: 15px; border-radius: 10px; border-left: 4px solid #f44336; margin: 15px 0; }
        .modal-body .info { background: #e3f2fd; padding: 15px; border-radius: 10px; border-left: 4px solid #2196f3; margin: 15px 0; }
        
        .modal-footer { padding: 20px; border-top: 1px solid #eee; display: flex; flex-direction: column; gap: 15px; }
        .read-confirm-checkbox { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .read-confirm-checkbox.disabled { opacity: 0.5; cursor: not-allowed; }
        .read-confirm-checkbox input { width: 20px; height: 20px; }
        .modal-validate-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #2d5a3d 0%, #4a8c5c 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
        }
        .modal-validate-btn:disabled { background: #ccc; cursor: not-allowed; }
        
        .admin-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .admin-modal.visible { display: flex; }
        .admin-content {
            background: white;
            border-radius: 20px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .admin-header {
            background: linear-gradient(135deg, #1a472a 0%, #2d5a3d 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .admin-header h2 { font-size: 18px; }
        .admin-body { padding: 20px; overflow-y: auto; flex: 1; }
        .admin-tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .admin-tab {
            padding: 10px 20px;
            background: #f0f0f0;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .admin-tab.active { background: #2d5a3d; color: white; }
        .admin-tab-content { display: none; }
        .admin-tab-content.active { display: block; }
        .admin-section { margin-bottom: 20px; }
        .admin-section h4 { color: #1a472a; margin-bottom: 10px; font-size: 14px; }
        .admin-section textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 13px;
            font-family: inherit;
            resize: vertical;
        }
        .admin-section textarea:focus { outline: none; border-color: #2d5a3d; }
        .admin-footer { padding: 20px; border-top: 1px solid #eee; display: flex; gap: 10px; justify-content: flex-end; }
        .admin-btn { padding: 12px 25px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .admin-btn.primary { background: #2d5a3d; color: white; }
        .admin-btn.secondary { background: #e0e0e0; color: #333; }
        .admin-help { background: #fff3e0; padding: 10px 15px; border-radius: 8px; margin-bottom: 15px; font-size: 12px; color: #e65100; }
        
        .alert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            padding: 15px 25px;
            border-radius: 12px;
            font-weight: 600;
            z-index: 3000;
            transition: transform 0.3s;
            max-width: 90%;
            text-align: center;
        }
        .alert.visible { transform: translateX(-50%) translateY(0); }
        .alert-success { background: #e8f5e9; color: #2e7d32; border: 2px solid #4caf50; }
        .alert-error { background: #ffebee; color: #c62828; border: 2px solid #f44336; }
        
        .success-page { display: none; text-align: center; padding: 40px 20px; }
        .success-page.visible { display: block; }
        .success-icon { font-size: 80px; margin-bottom: 20px; }
        .success-title { font-size: 24px; color: #2e7d32; margin-bottom: 15px; font-weight: 700; }
        .success-message { color: #666; line-height: 1.6; margin-bottom: 25px; }
        .success-btn { padding: 15px 30px; background: #2d5a3d; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; }
        
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.9);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .loading-overlay.visible { display: flex; }
        .spinner { width: 50px; height: 50px; border: 4px solid #e0e0e0; border-top-color: #2d5a3d; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 15px; font-weight: 600; color: #333; }
        
        .prefill-notice { background: #e8f5e9; border: 2px solid #4caf50; border-radius: 10px; padding: 12px 15px; margin-bottom: 20px; font-size: 13px; color: #2e7d32; text-align: center; }
        
        @media (max-width: 500px) {
            .form-row { grid-template-columns: 1fr; }
            .reglement-item { flex-wrap: wrap; }
            .reglement-read-btn { width: 100%; margin-top: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="admin-gear" onclick="openAdminLogin()">‚öôÔ∏è</div>
            <div class="header-logo">üé£</div>
            <div class="header-title">AAPPMA Gundershoffen</div>
            <div class="header-subtitle">Fiche de Renseignement P√™cheur</div>
        </div>
        
        <div class="card">
            <div id="formPage">
                <h1 class="page-title">üìã Fiche de Renseignement</h1>
                
                <div id="prefillNotice" class="prefill-notice" style="display:none;">
                    ‚úÖ Votre adresse email a √©t√© pr√©-remplie
                </div>
                
                <form id="ficheForm">
                    <div class="form-section-title">üë§ Informations du p√™cheur</div>
                    <div class="form-group required">
                        <label for="nom">Nom</label>
                        <input type="text" id="nom" required>
                    </div>
                    <div class="form-group required">
                        <label for="prenom">Pr√©nom</label>
                        <input type="text" id="prenom" required>
                    </div>
                    <div class="form-group required">
                        <label for="adresse">Adresse</label>
                        <input type="text" id="adresse" placeholder="12 rue de la Paix" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group required">
                            <label for="codePostal">Code postal</label>
                            <input type="text" id="codePostal" maxlength="5" placeholder="67110" required>
                        </div>
                        <div class="form-group required">
                            <label for="ville">Ville</label>
                            <select id="ville" required disabled>
                                <option value="">Entrez le code postal</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group required">
                        <label for="telephone">T√©l√©phone</label>
                        <input type="tel" id="telephone" placeholder="06 XX XX XX XX" required>
                    </div>
                    <div class="form-group required">
                        <label for="email">Email</label>
                        <input type="email" id="email" placeholder="votre@email.com" required>
                    </div>
                    
                    <div class="form-section-title">üö® Contact d'urgence</div>
                    <div class="form-group required">
                        <label for="urgenceNom">Nom</label>
                        <input type="text" id="urgenceNom" required>
                    </div>
                    <div class="form-group required">
                        <label for="urgencePrenom">Pr√©nom</label>
                        <input type="text" id="urgencePrenom" required>
                    </div>
                    <div class="form-group required">
                        <label for="urgenceTel">T√©l√©phone</label>
                        <input type="tel" id="urgenceTel" placeholder="06 XX XX XX XX" required>
                    </div>
                    
                    <div class="form-section-title">üìú R√®glements (obligatoire : cochez et lisez)</div>
                    <div class="reglement-list">
                        <div class="reglement-item" data-reglement="carpodrome">
                            <input type="checkbox" class="reglement-checkbox" id="check-carpodrome">
                            <span class="reglement-icon">üé£</span>
                            <span class="reglement-name">Carpodrome</span>
                            <span class="reglement-status unread" id="status-carpodrome">Non lu</span>
                            <button type="button" class="reglement-read-btn" data-for="carpodrome" disabled>üìñ Lire</button>
                        </div>
                        <div class="reglement-item" data-reglement="hardt">
                            <input type="checkbox" class="reglement-checkbox" id="check-hardt">
                            <span class="reglement-icon">üêü</span>
                            <span class="reglement-name">Hardt</span>
                            <span class="reglement-status unread" id="status-hardt">Non lu</span>
                            <button type="button" class="reglement-read-btn" data-for="hardt" disabled>üìñ Lire</button>
                        </div>
                        <div class="reglement-item" data-reglement="breitmatt">
                            <input type="checkbox" class="reglement-checkbox" id="check-breitmatt">
                            <span class="reglement-icon">üåä</span>
                            <span class="reglement-name">Breitmatt</span>
                            <span class="reglement-status unread" id="status-breitmatt">Non lu</span>
                            <button type="button" class="reglement-read-btn" data-for="breitmatt" disabled>üìñ Lire</button>
                        </div>
                    </div>
                    <p style="font-size: 12px; color: #666; margin-top: 10px; text-align: center;">
                        ‚ö†Ô∏è Vous devez cocher au moins un r√®glement, puis le lire et confirmer la lecture
                    </p>
                    
                    <button type="submit" class="btn-submit" id="submitBtn" disabled>
                        ‚úâÔ∏è Envoyer ma fiche
                    </button>
                </form>
            </div>
            
            <div id="successPage" class="success-page">
                <div class="success-icon">‚úÖ</div>
                <div class="success-title">Fiche envoy√©e avec succ√®s !</div>
                <div class="success-message">
                    Votre fiche de renseignement a √©t√© enregistr√©e et envoy√©e √† l'AAPPMA Gundershoffen.<br><br>
                    Merci pour votre inscription !
                </div>
                <button class="success-btn" onclick="window.close()">Fermer</button>
            </div>
        </div>
        
        <p style="text-align: center; color: rgba(255,255,255,0.7); margin-top: 20px; font-size: 12px;">
            ¬© 2026 AAPPMA Gundershoffen - www.aappma-gundershoffen.fr
        </p>
    </div>
    
    <!-- Modal R√®glement -->
    <div class="modal-overlay" id="reglementModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">üìú R√®glement</h2>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div class="modal-progress-container">
                <div class="modal-progress-bar-bg">
                    <div class="modal-progress-bar" id="modalProgressBar"></div>
                </div>
                <div class="modal-progress-status" id="modalProgressStatus">‚¨áÔ∏è Faites d√©filer pour lire le r√®glement complet</div>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer">
                <label class="read-confirm-checkbox disabled" id="readConfirmLabel">
                    <input type="checkbox" id="readConfirmCheckbox" disabled>
                    <span>J'ai lu et compris le r√®glement</span>
                </label>
                <button class="modal-validate-btn" id="modalValidateBtn" disabled>‚úÖ Confirmer la lecture</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Admin -->
    <div class="admin-modal" id="adminModal">
        <div class="admin-content">
            <div class="admin-header">
                <h2>‚öôÔ∏è Administration des r√®glements</h2>
                <button class="modal-close" onclick="closeAdminModal()">&times;</button>
            </div>
            <div class="admin-body">
                <div id="adminPasswordSection">
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 50px; margin-bottom: 15px;">üîê</div>
                        <h3 style="margin-bottom: 20px;">Acc√®s prot√©g√©</h3>
                        <div class="form-group">
                            <input type="password" id="adminPassword" placeholder="Mot de passe" style="max-width: 300px; margin: 0 auto;" onkeyup="if(event.key==='Enter')checkAdminPassword()">
                        </div>
                        <p id="adminPasswordError" style="color: #c62828; display: none; margin-bottom: 15px;">‚ùå Mot de passe incorrect</p>
                        <button class="admin-btn primary" onclick="checkAdminPassword()">Valider</button>
                    </div>
                </div>
                
                <div id="adminContentSection" style="display: none;">
                    <div class="admin-help">
                        üí° <strong>Formatage :</strong><br>
                        ‚Ä¢ Titres : commencez par un emoji (üóìÔ∏è üé´ üé£ ‚õî üëÆ)<br>
                        ‚Ä¢ Listes : commencez la ligne par <code>-</code><br>
                        ‚Ä¢ Avertissement orange : commencez par <code>‚ö†Ô∏è</code><br>
                        ‚Ä¢ Interdiction : commencez par <code>‚ùå</code><br>
                        ‚Ä¢ Ligne vide = nouveau paragraphe
                    </div>
                    
                    <div class="admin-tabs">
                        <div class="admin-tab active" onclick="switchAdminTab('carpodrome')">üé£ Carpodrome</div>
                        <div class="admin-tab" onclick="switchAdminTab('hardt')">üêü Hardt</div>
                        <div class="admin-tab" onclick="switchAdminTab('breitmatt')">üåä Breitmatt</div>
                    </div>
                    
                    <div class="admin-tab-content active" id="tabCarpodrome">
                        <div class="admin-section">
                            <h4>üìÑ R√®glement complet Carpodrome</h4>
                            <textarea id="carpodrome_contenu" style="min-height: 400px;"></textarea>
                        </div>
                    </div>
                    
                    <div class="admin-tab-content" id="tabHardt">
                        <div class="admin-section">
                            <h4>üìÑ R√®glement complet Hardt</h4>
                            <textarea id="hardt_contenu" style="min-height: 400px;"></textarea>
                        </div>
                    </div>
                    
                    <div class="admin-tab-content" id="tabBreitmatt">
                        <div class="admin-section">
                            <h4>üìÑ R√®glement complet Breitmatt</h4>
                            <textarea id="breitmatt_contenu" style="min-height: 400px;"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="admin-footer" id="adminFooter" style="display: none;">
                <button class="admin-btn secondary" onclick="closeAdminModal()">Annuler</button>
                <button class="admin-btn primary" onclick="saveAdminContent()">üíæ Enregistrer</button>
            </div>
        </div>
    </div>
    
    <div class="alert" id="alert"></div>
    
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">Envoi en cours...</div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
        const firebaseConfig = { databaseURL: "https://appli-controleur-gunder-default-rtdb.europe-west1.firebasedatabase.app" };
        const ADMIN_PASSWORD = "adminformulaire";
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.database(app);
        
        let currentReglement = null;
        let modalScrollComplete = false;
        const reglementsRead = { carpodrome: false, hardt: false, breitmatt: false };
        let reglementsData = null;
        
        async function loadReglementsFromFirebase() {
            try {
                const snap = await db.ref('reglements_formulaire').once('value');
                reglementsData = snap.val();
                console.log(reglementsData ? '‚úÖ R√®glements charg√©s depuis Firebase' : '‚ÑπÔ∏è Pas de r√®glements dans Firebase');
            } catch (e) { console.log('‚ö†Ô∏è Erreur:', e.message); }
        }
        
        function generateReglementHTML(type) {
            if (!reglementsData || !reglementsData[type]) return '<p style="text-align:center;color:#999;">R√®glement non disponible</p>';
            const contenu = reglementsData[type].contenu || reglementsData[type];
            if (typeof contenu === 'string') {
                return formatText(contenu);
            }
            // Ancien format avec sections s√©par√©es - on les concat√®ne
            let text = '';
            if (contenu.horaires) text += contenu.horaires + '\n\n';
            if (contenu.tarifs) text += contenu.tarifs + '\n\n';
            if (contenu.modalites) text += contenu.modalites + '\n\n';
            if (contenu.regles) text += contenu.regles + '\n\n';
            if (contenu.interdictions) text += contenu.interdictions + '\n\n';
            if (contenu.sanctions) text += contenu.sanctions;
            return formatText(text);
        }
        
        function formatText(text) {
            if (!text) return '';
            const lines = text.split('\n');
            let html = '';
            let inList = false;
            lines.forEach(line => {
                line = line.trim();
                if (!line) {
                    if (inList) { html += '</ul>'; inList = false; }
                    return;
                }
                // Titre avec emoji (ex: üóìÔ∏è P√âRIODES ET HORAIRES)
                if (/^[üóìÔ∏èüé´üé£‚õîüëÆüë∂üóëÔ∏èüö®üìã]/.test(line) && !line.startsWith('-') && !line.startsWith('‚ö†Ô∏è') && !line.startsWith('‚ùå') && line.length < 100) {
                    if (inList) { html += '</ul>'; inList = false; }
                    html += `<h3>${line}</h3>`;
                }
                // Ligne commence par -
                else if (line.startsWith('-')) {
                    if (!inList) { html += '<ul>'; inList = true; }
                    html += `<li>${line.substring(1).trim()}</li>`;
                }
                // Ligne commence par ‚ö†Ô∏è
                else if (line.startsWith('‚ö†Ô∏è')) {
                    if (inList) { html += '</ul>'; inList = false; }
                    html += `<div class="important">${line}</div>`;
                }
                // Ligne commence par ‚ùå
                else if (line.startsWith('‚ùå')) {
                    if (!inList) { html += '<ul>'; inList = true; }
                    html += `<li>${line}</li>`;
                }
                // Ligne normale
                else {
                    if (inList) { html += '</ul>'; inList = false; }
                    html += `<p>${line}</p>`;
                }
            });
            if (inList) html += '</ul>';
            return html;
        }
        
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return { email: params.get('email'), nom: params.get('nom'), prenom: params.get('prenom') };
        }
        
        document.addEventListener('DOMContentLoaded', async function() {
            await loadReglementsFromFirebase();
            const params = getUrlParams();
            if (params.email) {
                document.getElementById('email').value = params.email;
                document.getElementById('email').classList.add('prefilled');
                document.getElementById('prefillNotice').style.display = 'block';
            }
            if (params.nom) document.getElementById('nom').value = params.nom;
            if (params.prenom) document.getElementById('prenom').value = params.prenom;
        });
        
        document.querySelectorAll('.reglement-checkbox').forEach(cb => {
            cb.addEventListener('change', function() {
                const reglement = this.closest('.reglement-item').dataset.reglement;
                const readBtn = document.querySelector(`.reglement-read-btn[data-for="${reglement}"]`);
                const item = this.closest('.reglement-item');
                if (this.checked) { readBtn.disabled = false; item.classList.add('checked'); }
                else { readBtn.disabled = true; item.classList.remove('checked'); reglementsRead[reglement] = false; updateReglementStatus(reglement); }
                updateSubmitButton();
            });
        });
        
        document.querySelectorAll('.reglement-read-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                currentReglement = this.dataset.for;
                modalScrollComplete = false;
                const titles = { carpodrome: 'üé£ R√àGLEMENT CARPODROME 2026', hardt: 'üêü R√àGLEMENT HARDT 2026', breitmatt: 'üåä R√àGLEMENT BREITMATT 2026' };
                document.getElementById('modalTitle').textContent = titles[currentReglement];
                document.getElementById('modalBody').innerHTML = generateReglementHTML(currentReglement);
                document.getElementById('modalBody').scrollTop = 0;
                document.getElementById('modalProgressBar').style.width = '0%';
                document.getElementById('modalProgressStatus').textContent = '‚¨áÔ∏è Faites d√©filer pour lire le r√®glement complet';
                document.getElementById('modalProgressStatus').classList.remove('complete');
                document.getElementById('readConfirmCheckbox').checked = false;
                document.getElementById('readConfirmCheckbox').disabled = true;
                document.getElementById('readConfirmLabel').classList.add('disabled');
                document.getElementById('modalValidateBtn').disabled = true;
                document.getElementById('reglementModal').classList.add('visible');
                setTimeout(() => checkScrollProgress(), 100);
            });
        });
        
        document.getElementById('modalBody').addEventListener('scroll', checkScrollProgress);
        
        function checkScrollProgress() {
            const modalBody = document.getElementById('modalBody');
            const maxScroll = modalBody.scrollHeight - modalBody.clientHeight;
            let scrollPercent = maxScroll <= 0 ? 100 : Math.min(100, Math.round((modalBody.scrollTop / maxScroll) * 100));
            document.getElementById('modalProgressBar').style.width = scrollPercent + '%';
            if (scrollPercent >= 95 && !modalScrollComplete) {
                modalScrollComplete = true;
                document.getElementById('modalProgressStatus').textContent = '‚úÖ R√®glement lu en entier';
                document.getElementById('modalProgressStatus').classList.add('complete');
                document.getElementById('readConfirmCheckbox').disabled = false;
                document.getElementById('readConfirmLabel').classList.remove('disabled');
            }
        }
        
        document.getElementById('modalClose').addEventListener('click', () => document.getElementById('reglementModal').classList.remove('visible'));
        document.getElementById('reglementModal').addEventListener('click', (e) => { if (e.target.id === 'reglementModal') document.getElementById('reglementModal').classList.remove('visible'); });
        
        document.getElementById('readConfirmCheckbox').addEventListener('change', function() { document.getElementById('modalValidateBtn').disabled = !this.checked; });
        
        document.getElementById('modalValidateBtn').addEventListener('click', () => {
            reglementsRead[currentReglement] = true;
            updateReglementStatus(currentReglement);
            document.getElementById('reglementModal').classList.remove('visible');
            updateSubmitButton();
            showAlert('‚úÖ R√®glement ' + currentReglement.toUpperCase() + ' valid√© !', 'success');
        });
        
        function updateReglementStatus(reglement) {
            const status = document.getElementById('status-' + reglement);
            if (reglementsRead[reglement]) { status.textContent = '‚úÖ Lu'; status.className = 'reglement-status read'; }
            else { status.textContent = 'Non lu'; status.className = 'reglement-status unread'; }
        }
        
        function updateSubmitButton() {
            const checkedReglements = document.querySelectorAll('.reglement-checkbox:checked');
            let allCheckedAreRead = true;
            checkedReglements.forEach(cb => { if (!reglementsRead[cb.closest('.reglement-item').dataset.reglement]) allCheckedAreRead = false; });
            document.getElementById('submitBtn').disabled = !(checkedReglements.length > 0 && allCheckedAreRead);
        }
        
        function openAdminLogin() {
            document.getElementById('adminPasswordSection').style.display = 'block';
            document.getElementById('adminContentSection').style.display = 'none';
            document.getElementById('adminFooter').style.display = 'none';
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminPasswordError').style.display = 'none';
            document.getElementById('adminModal').classList.add('visible');
        }
        
        function closeAdminModal() { document.getElementById('adminModal').classList.remove('visible'); }
        
        function checkAdminPassword() {
            if (document.getElementById('adminPassword').value === ADMIN_PASSWORD) {
                document.getElementById('adminPasswordSection').style.display = 'none';
                document.getElementById('adminContentSection').style.display = 'block';
                document.getElementById('adminFooter').style.display = 'flex';
                loadAdminContent();
            } else { document.getElementById('adminPasswordError').style.display = 'block'; }
        }
        
        function switchAdminTab(tab) {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`.admin-tab:nth-child(${tab === 'carpodrome' ? 1 : tab === 'hardt' ? 2 : 3})`).classList.add('active');
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
        }
        
        function loadAdminContent() {
            if (!reglementsData) return;
            
            // Carpodrome
            if (reglementsData.carpodrome) {
                const carpo = reglementsData.carpodrome;
                if (typeof carpo === 'string') {
                    document.getElementById('carpodrome_contenu').value = carpo;
                } else if (carpo.contenu) {
                    document.getElementById('carpodrome_contenu').value = carpo.contenu;
                } else {
                    // Ancien format - concat√©ner les sections
                    let text = '';
                    if (carpo.horaires) text += carpo.horaires + '\n\n';
                    if (carpo.tarifs) text += carpo.tarifs + '\n\n';
                    if (carpo.modalites) text += carpo.modalites + '\n\n';
                    if (carpo.interdictions) text += carpo.interdictions + '\n\n';
                    if (carpo.sanctions) text += carpo.sanctions;
                    document.getElementById('carpodrome_contenu').value = text.trim();
                }
            }
            
            // Hardt
            if (reglementsData.hardt) {
                const hardt = reglementsData.hardt;
                if (typeof hardt === 'string') {
                    document.getElementById('hardt_contenu').value = hardt;
                } else if (hardt.contenu) {
                    document.getElementById('hardt_contenu').value = hardt.contenu;
                } else {
                    let text = '';
                    if (hardt.horaires) text += hardt.horaires + '\n\n';
                    if (hardt.tarifs) text += hardt.tarifs + '\n\n';
                    if (hardt.modalites) text += hardt.modalites + '\n\n';
                    if (hardt.interdictions) text += hardt.interdictions + '\n\n';
                    if (hardt.sanctions) text += hardt.sanctions;
                    document.getElementById('hardt_contenu').value = text.trim();
                }
            }
            
            // Breitmatt
            if (reglementsData.breitmatt) {
                const breit = reglementsData.breitmatt;
                if (typeof breit === 'string') {
                    document.getElementById('breitmatt_contenu').value = breit;
                } else if (breit.contenu) {
                    document.getElementById('breitmatt_contenu').value = breit.contenu;
                } else {
                    let text = '';
                    if (breit.horaires) text += breit.horaires + '\n\n';
                    if (breit.regles) text += breit.regles + '\n\n';
                    if (breit.interdictions) text += breit.interdictions + '\n\n';
                    if (breit.sanctions) text += breit.sanctions;
                    document.getElementById('breitmatt_contenu').value = text.trim();
                }
            }
        }
        
        function saveAdminContent() {
            const allReglements = {
                carpodrome: { contenu: document.getElementById('carpodrome_contenu').value.trim() },
                hardt: { contenu: document.getElementById('hardt_contenu').value.trim() },
                breitmatt: { contenu: document.getElementById('breitmatt_contenu').value.trim() }
            };
            db.ref('reglements_formulaire').set(allReglements)
                .then(() => { reglementsData = allReglements; closeAdminModal(); showAlert('‚úÖ R√®glements enregistr√©s !', 'success'); })
                .catch((error) => { console.error('Erreur:', error); showAlert('‚ùå Erreur lors de la sauvegarde', 'error'); });
        }
        
        document.getElementById('codePostal').addEventListener('input', async function() {
            const cp = this.value.trim();
            const villeSelect = document.getElementById('ville');
            if (cp.length === 5) {
                try {
                    const response = await fetch(`https://geo.api.gouv.fr/communes?codePostal=${cp}&fields=nom`);
                    const data = await response.json();
                    villeSelect.innerHTML = '';
                    if (data.length > 0) {
                        data.forEach(ville => { const option = document.createElement('option'); option.value = ville.nom; option.textContent = ville.nom; villeSelect.appendChild(option); });
                        villeSelect.disabled = false;
                    } else { villeSelect.innerHTML = '<option value="">Aucune ville trouv√©e</option>'; villeSelect.disabled = true; }
                } catch (e) { villeSelect.innerHTML = '<option value="">Erreur de chargement</option>'; }
            } else { villeSelect.innerHTML = '<option value="">Entrez le code postal</option>'; villeSelect.disabled = true; }
        });
        
        document.getElementById('ficheForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const nom = document.getElementById('nom').value.toUpperCase().trim();
            const prenom = document.getElementById('prenom').value.trim();
            const reglementsValides = [];
            document.querySelectorAll('.reglement-checkbox:checked').forEach(cb => { const reg = cb.closest('.reglement-item').dataset.reglement; if (reglementsRead[reg]) reglementsValides.push(reg.toUpperCase()); });
            document.getElementById('loading').classList.add('visible');
            try {
                const ficheData = {
                    nom: nom, prenom: prenom,
                    adresse: document.getElementById('adresse').value.trim(),
                    codePostal: document.getElementById('codePostal').value.trim(),
                    ville: document.getElementById('ville').value,
                    telephone: document.getElementById('telephone').value.trim(),
                    email: document.getElementById('email').value.trim(),
                    urgence: { nom: document.getElementById('urgenceNom').value.toUpperCase().trim(), prenom: document.getElementById('urgencePrenom').value.trim(), telephone: document.getElementById('urgenceTel').value.trim() },
                    reglements: reglementsValides,
                    date: new Date().toLocaleString('fr-FR'),
                    id: Date.now().toString(),
                    source: 'formulaire-public'
                };
                await db.ref('fiches').push(ficheData);
                document.getElementById('loading').classList.remove('visible');
                document.getElementById('formPage').style.display = 'none';
                document.getElementById('successPage').classList.add('visible');
            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('loading').classList.remove('visible');
                showAlert('‚ùå Erreur lors de l\'envoi. Veuillez r√©essayer.', 'error');
            }
        });
        
        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = 'alert alert-' + type + ' visible';
            setTimeout(() => alert.classList.remove('visible'), 4000);
        }
    </script>
</body>
</html>
