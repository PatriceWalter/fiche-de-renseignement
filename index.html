<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiche de Renseignement - AAPPMA Gundershoffen</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: linear-gradient(135deg, #1a472a 0%, #2d5a3d 50%, #3d7a5a 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container { max-width: 600px; margin: 0 auto; }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 25px;
            position: relative;
        }
        .header-logo { font-size: 50px; margin-bottom: 10px; }
        .header-title { font-size: 24px; font-weight: 700; margin-bottom: 5px; }
        .header-subtitle { font-size: 14px; opacity: 0.9; }
        .admin-gear { position: absolute; top: 0; right: 0; font-size: 1.5em; cursor: pointer; opacity: 0.7; transition: 0.3s; }
        .admin-gear:hover { opacity: 1; transform: rotate(90deg); }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .page-title {
            font-size: 22px;
            color: #1a472a;
            margin-bottom: 25px;
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 2px solid #e8f5e9;
        }
        
        .form-section-title {
            font-size: 16px;
            font-weight: 700;
            color: #2d5a3d;
            margin: 25px 0 15px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #e8f5e9;
        }
        .form-section-title:first-of-type { margin-top: 0; }
        
        .form-group { margin-bottom: 18px; }
        .form-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
            font-size: 14px;
        }
        .form-group.required label::after { content: " *"; color: #c62828; }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #2d5a3d;
            box-shadow: 0 0 0 3px rgba(45,90,61,0.1);
        }
        .form-group input.prefilled { background: #e8f5e9; border-color: #4caf50; }
        
        .form-row { display: grid; grid-template-columns: 1fr 2fr; gap: 15px; }
        
        .reglement-list { margin-top: 10px; }
        .reglement-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 10px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        .reglement-item.checked { background: #e8f5e9; border-color: #4caf50; }
        .reglement-checkbox { width: 22px; height: 22px; cursor: pointer; }
        .reglement-icon { font-size: 24px; }
        .reglement-name { flex: 1; font-weight: 600; color: #333; }
        .reglement-read-btn {
            padding: 8px 16px;
            background: #e0e0e0;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            cursor: not-allowed;
            transition: all 0.3s;
        }
        .reglement-read-btn:not(:disabled) { background: #2d5a3d; color: white; cursor: pointer; }
        .reglement-read-btn:not(:disabled):hover { background: #1a472a; }
        .reglement-status { font-size: 12px; padding: 4px 10px; border-radius: 20px; font-weight: 600; }
        .reglement-status.read { background: #e8f5e9; color: #2e7d32; }
        .reglement-status.unread { background: #ffebee; color: #c62828; }
        
        .btn-submit {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #2d5a3d 0%, #4a8c5c 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 25px;
            transition: all 0.3s;
        }
        .btn-submit:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(45,90,61,0.3); }
        .btn-submit:disabled { background: #ccc; cursor: not-allowed; }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-overlay.visible { display: flex; }
        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .modal-content.large { max-width: 800px; }
        .modal-header {
            background: linear-gradient(135deg, #2d5a3d 0%, #4a8c5c 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 { font-size: 18px; }
        .modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
        }
        .modal-body {
            padding: 25px;
            overflow-y: auto;
            flex: 1;
            font-size: 14px;
            line-height: 1.7;
        }
        .modal-body h3 { color: #1a472a; margin: 20px 0 10px; font-size: 16px; }
        .modal-body h3:first-child { margin-top: 0; }
        .modal-body ul { margin-left: 20px; margin-bottom: 15px; }
        .modal-body li { margin-bottom: 5px; }
        .modal-body .important { background: #fff3e0; padding: 15px; border-radius: 10px; border-left: 4px solid #ff9800; margin: 15px 0; }
        .modal-body .interdit { color: #c62828; }
        .modal-body .contact-box { background: #e8f5e9; padding: 15px; border-radius: 10px; margin-top: 15px; }
        
        .modal-progress-container { padding: 0 20px; background: #f5f5f5; }
        .modal-progress { background: #e0e0e0; height: 8px; border-radius: 4px; overflow: hidden; }
        .modal-progress-bar { background: #2d5a3d; height: 100%; width: 0%; transition: width 0.3s; }
        .modal-progress-status { text-align: center; padding: 10px; font-size: 12px; color: #666; }
        .modal-progress-status.complete { color: #2e7d32; font-weight: bold; }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .read-confirm-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .read-confirm-checkbox.disabled { opacity: 0.5; cursor: not-allowed; }
        .read-confirm-checkbox input { width: 20px; height: 20px; }
        .modal-validate-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #2d5a3d 0%, #4a8c5c 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
        }
        .modal-validate-btn:disabled { background: #ccc; cursor: not-allowed; }
        
        .admin-tabs { display: flex; border-bottom: 2px solid #e0e0e0; margin-bottom: 20px; flex-wrap: wrap; }
        .admin-tab { padding: 12px 15px; cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -2px; font-weight: 600; color: #666; transition: 0.3s; font-size: 13px; }
        .admin-tab:hover { color: #2d5a3d; }
        .admin-tab.active { color: #2d5a3d; border-bottom-color: #2d5a3d; }
        .admin-tab-content { display: none; max-height: 400px; overflow-y: auto; }
        .admin-tab-content.active { display: block; }
        .admin-section { background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .admin-section h4 { color: #2d5a3d; margin-bottom: 10px; font-size: 14px; }
        .admin-section textarea { min-height: 80px; font-size: 13px; }
        .admin-btn { padding: 12px 25px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .admin-btn.primary { background: #2d5a3d; color: white; }
        .admin-btn.secondary { background: #6c757d; color: white; }
        
        .alert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            padding: 15px 25px;
            border-radius: 12px;
            font-weight: 600;
            z-index: 2000;
            transition: transform 0.3s;
            max-width: 90%;
            text-align: center;
        }
        .alert.visible { transform: translateX(-50%) translateY(0); }
        .alert-success { background: #e8f5e9; color: #2e7d32; border: 2px solid #4caf50; }
        .alert-error { background: #ffebee; color: #c62828; border: 2px solid #f44336; }
        
        .success-page { display: none; text-align: center; padding: 40px 20px; }
        .success-page.visible { display: block; }
        .success-icon { font-size: 80px; margin-bottom: 20px; }
        .success-title { font-size: 24px; color: #2e7d32; margin-bottom: 15px; font-weight: 700; }
        .success-message { color: #666; line-height: 1.6; margin-bottom: 25px; }
        .success-btn { padding: 15px 30px; background: #2d5a3d; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; }
        
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.9);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .loading-overlay.visible { display: flex; }
        .spinner { width: 50px; height: 50px; border: 4px solid #e0e0e0; border-top-color: #2d5a3d; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 15px; font-weight: 600; color: #333; }
        
        .prefill-notice {
            background: #e8f5e9;
            border: 2px solid #4caf50;
            border-radius: 10px;
            padding: 12px 15px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #2e7d32;
            text-align: center;
        }
        
        @media (max-width: 500px) {
            .form-row { grid-template-columns: 1fr; }
            .reglement-item { flex-wrap: wrap; }
            .reglement-read-btn { width: 100%; margin-top: 10px; }
            .admin-tab { padding: 10px 12px; font-size: 12px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <span class="admin-gear" onclick="openAdminModal()">âš™ï¸</span>
            <div class="header-logo">ğŸ£</div>
            <div class="header-title">AAPPMA Gundershoffen</div>
            <div class="header-subtitle">Fiche de Renseignement PÃªcheur</div>
        </div>
        
        <div class="card">
            <div id="formPage">
                <h1 class="page-title">ğŸ“‹ Fiche de Renseignement</h1>
                
                <div id="prefillNotice" class="prefill-notice" style="display:none;">
                    âœ… Votre adresse email a Ã©tÃ© prÃ©-remplie
                </div>
                
                <form id="ficheForm">
                    <div class="form-section-title">ğŸ‘¤ Informations du pÃªcheur</div>
                    <div class="form-group required">
                        <label for="nom">Nom</label>
                        <input type="text" id="nom" required>
                    </div>
                    <div class="form-group required">
                        <label for="prenom">PrÃ©nom</label>
                        <input type="text" id="prenom" required>
                    </div>
                    <div class="form-group required">
                        <label for="adresse">Adresse</label>
                        <input type="text" id="adresse" placeholder="12 rue de la Paix" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group required">
                            <label for="codePostal">Code postal</label>
                            <input type="text" id="codePostal" maxlength="5" placeholder="67110" required>
                        </div>
                        <div class="form-group required">
                            <label for="ville">Ville</label>
                            <select id="ville" required disabled>
                                <option value="">Entrez le code postal</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group required">
                        <label for="telephone">TÃ©lÃ©phone</label>
                        <input type="tel" id="telephone" placeholder="06 XX XX XX XX" required>
                    </div>
                    <div class="form-group required">
                        <label for="email">Email</label>
                        <input type="email" id="email" placeholder="votre@email.com" required>
                    </div>
                    
                    <div class="form-section-title">ğŸš¨ Contact d'urgence</div>
                    <div class="form-group required">
                        <label for="urgenceNom">Nom</label>
                        <input type="text" id="urgenceNom" required>
                    </div>
                    <div class="form-group required">
                        <label for="urgencePrenom">PrÃ©nom</label>
                        <input type="text" id="urgencePrenom" required>
                    </div>
                    <div class="form-group required">
                        <label for="urgenceTel">TÃ©lÃ©phone</label>
                        <input type="tel" id="urgenceTel" placeholder="06 XX XX XX XX" required>
                    </div>
                    
                    <div class="form-section-title">ğŸ“œ RÃ¨glements (obligatoire : cochez et lisez)</div>
                    <div class="reglement-list">
                        <div class="reglement-item" data-reglement="carpodrome">
                            <input type="checkbox" class="reglement-checkbox" id="check-carpodrome">
                            <span class="reglement-icon">ğŸ£</span>
                            <span class="reglement-name">Carpodrome</span>
                            <span class="reglement-status unread" id="status-carpodrome">Non lu</span>
                            <button type="button" class="reglement-read-btn" data-for="carpodrome" disabled>ğŸ“– Lire</button>
                        </div>
                        <div class="reglement-item" data-reglement="hardt">
                            <input type="checkbox" class="reglement-checkbox" id="check-hardt">
                            <span class="reglement-icon">ğŸŸ</span>
                            <span class="reglement-name">Hardt</span>
                            <span class="reglement-status unread" id="status-hardt">Non lu</span>
                            <button type="button" class="reglement-read-btn" data-for="hardt" disabled>ğŸ“– Lire</button>
                        </div>
                        <div class="reglement-item" data-reglement="breitmatt">
                            <input type="checkbox" class="reglement-checkbox" id="check-breitmatt">
                            <span class="reglement-icon">ğŸŒŠ</span>
                            <span class="reglement-name">Breitmatt</span>
                            <span class="reglement-status unread" id="status-breitmatt">Non lu</span>
                            <button type="button" class="reglement-read-btn" data-for="breitmatt" disabled>ğŸ“– Lire</button>
                        </div>
                    </div>
                    <p style="font-size: 12px; color: #666; margin-top: 10px; text-align: center;">
                        âš ï¸ Vous devez cocher au moins un rÃ¨glement, puis le lire entiÃ¨rement et confirmer la lecture
                    </p>
                    
                    <button type="submit" class="btn-submit" id="submitBtn" disabled>
                        âœ‰ï¸ Envoyer ma fiche
                    </button>
                </form>
            </div>
            
            <div id="successPage" class="success-page">
                <div class="success-icon">âœ…</div>
                <div class="success-title">Fiche envoyÃ©e avec succÃ¨s !</div>
                <div class="success-message">
                    Votre fiche de renseignement a Ã©tÃ© enregistrÃ©e et envoyÃ©e Ã  l'AAPPMA Gundershoffen.<br><br>
                    Merci pour votre inscription !
                </div>
                <button class="success-btn" onclick="location.reload()">Nouvelle fiche</button>
            </div>
        </div>
        
        <p style="text-align: center; color: rgba(255,255,255,0.7); margin-top: 20px; font-size: 12px;">
            Â© 2026 AAPPMA Gundershoffen - www.aappma-gundershoffen.fr
        </p>
    </div>
    
    <!-- Modal RÃ¨glement -->
    <div class="modal-overlay" id="reglementModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">ğŸ“œ RÃ¨glement</h2>
                <button class="modal-close" onclick="closeReglementModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody" onscroll="checkModalScroll()"></div>
            <div class="modal-progress-container">
                <div class="modal-progress"><div class="modal-progress-bar" id="modalProgressBar"></div></div>
                <div class="modal-progress-status" id="modalProgressStatus">â¬‡ï¸ Faites dÃ©filer pour lire le rÃ¨glement complet</div>
            </div>
            <div class="modal-footer">
                <label class="read-confirm-checkbox disabled" id="readConfirmLabel">
                    <input type="checkbox" id="readConfirmCheckbox" disabled>
                    <span>J'ai lu et compris le rÃ¨glement</span>
                </label>
                <button class="modal-validate-btn" id="modalValidateBtn" disabled>âœ… Confirmer la lecture</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Admin -->
    <div class="modal-overlay" id="adminModal">
        <div class="modal-content large">
            <div class="modal-header">
                <h2>âš™ï¸ Administration des rÃ¨glements</h2>
                <button class="modal-close" onclick="closeAdminModal()">&times;</button>
            </div>
            <div class="modal-body" style="max-height: none;">
                <div id="adminPasswordSection">
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 50px; margin-bottom: 15px;">ğŸ”</div>
                        <h3 style="margin-bottom: 20px;">AccÃ¨s protÃ©gÃ©</h3>
                        <div class="form-group">
                            <input type="password" id="adminPassword" placeholder="Mot de passe" style="max-width: 300px; margin: 0 auto;" onkeyup="if(event.key==='Enter')checkAdminPassword()">
                        </div>
                        <p id="adminPasswordError" style="color: #c62828; display: none; margin-bottom: 15px;">âŒ Mot de passe incorrect</p>
                        <button class="admin-btn primary" onclick="checkAdminPassword()">Valider</button>
                    </div>
                </div>
                
                <div id="adminContentSection" style="display: none;">
                    <p style="background: #fff3e0; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 12px;">
                        ğŸ’¡ Utilisez <strong>-</strong> au dÃ©but d'une ligne pour une liste, <strong>âš ï¸</strong> pour un avertissement, <strong>âŒ</strong> pour une interdiction
                    </p>
                    
                    <div class="admin-tabs">
                        <div class="admin-tab active" onclick="switchAdminTab('carpodrome')">ğŸ£ Carpodrome</div>
                        <div class="admin-tab" onclick="switchAdminTab('hardt')">ğŸŸ Hardt</div>
                        <div class="admin-tab" onclick="switchAdminTab('breitmatt')">ğŸŒŠ Breitmatt</div>
                    </div>
                    
                    <div class="admin-tab-content active" id="tabCarpodrome">
                        <div class="admin-section"><h4>ğŸ—“ï¸ PÃ©riodes et horaires</h4><textarea id="carpodrome_horaires"></textarea></div>
                        <div class="admin-section"><h4>ğŸ« RÃ©servation et tarifs</h4><textarea id="carpodrome_tarifs"></textarea></div>
                        <div class="admin-section"><h4>ğŸ£ ModalitÃ©s de pÃªche</h4><textarea id="carpodrome_modalites"></textarea></div>
                        <div class="admin-section"><h4>ğŸ‘¶ PÃªche des mineurs</h4><textarea id="carpodrome_mineurs"></textarea></div>
                        <div class="admin-section"><h4>ğŸ‘® ContrÃ´les et sanctions</h4><textarea id="carpodrome_sanctions"></textarea></div>
                        <div class="admin-section"><h4>â›” Interdictions</h4><textarea id="carpodrome_interdictions"></textarea></div>
                        <div class="admin-section"><h4>ğŸ—‘ï¸ Gestion des dÃ©chets</h4><textarea id="carpodrome_dechets"></textarea></div>
                        <div class="admin-section"><h4>ğŸ“ Contacts</h4><textarea id="carpodrome_contacts"></textarea></div>
                    </div>
                    
                    <div class="admin-tab-content" id="tabHardt">
                        <div class="admin-section"><h4>ğŸ—“ï¸ PÃ©riodes et horaires</h4><textarea id="hardt_horaires"></textarea></div>
                        <div class="admin-section"><h4>ğŸ« Cartes et tarifs</h4><textarea id="hardt_tarifs"></textarea></div>
                        <div class="admin-section"><h4>ğŸ£ ModalitÃ©s de pÃªche</h4><textarea id="hardt_modalites"></textarea></div>
                        <div class="admin-section"><h4>ğŸŒ™ PÃªche de nuit</h4><textarea id="hardt_nuit"></textarea></div>
                        <div class="admin-section"><h4>ğŸ‘¶ PÃªche des mineurs</h4><textarea id="hardt_mineurs"></textarea></div>
                        <div class="admin-section"><h4>ğŸ‘® ContrÃ´les et sanctions</h4><textarea id="hardt_sanctions"></textarea></div>
                        <div class="admin-section"><h4>â›” Interdictions</h4><textarea id="hardt_interdictions"></textarea></div>
                        <div class="admin-section"><h4>ğŸ¯ PÃªche aux carnassiers</h4><textarea id="hardt_carnassiers"></textarea></div>
                        <div class="admin-section"><h4>ğŸ—‘ï¸ Gestion des dÃ©chets</h4><textarea id="hardt_dechets"></textarea></div>
                        <div class="admin-section"><h4>ğŸ“ Contacts</h4><textarea id="hardt_contacts"></textarea></div>
                    </div>
                    
                    <div class="admin-tab-content" id="tabBreitmatt">
                        <div class="admin-section"><h4>ğŸ—“ï¸ PÃ©riodes et horaires</h4><textarea id="breitmatt_horaires"></textarea></div>
                        <div class="admin-section"><h4>ğŸ« Cartes et tarifs</h4><textarea id="breitmatt_tarifs"></textarea></div>
                        <div class="admin-section"><h4>ğŸ£ ModalitÃ©s de pÃªche</h4><textarea id="breitmatt_modalites"></textarea></div>
                        <div class="admin-section"><h4>ğŸ‘¶ PÃªche des mineurs</h4><textarea id="breitmatt_mineurs"></textarea></div>
                        <div class="admin-section"><h4>ğŸ‘® ContrÃ´les et sanctions</h4><textarea id="breitmatt_sanctions"></textarea></div>
                        <div class="admin-section"><h4>â›” Interdictions</h4><textarea id="breitmatt_interdictions"></textarea></div>
                        <div class="admin-section"><h4>ğŸ¯ PÃªche aux carnassiers</h4><textarea id="breitmatt_carnassiers"></textarea></div>
                        <div class="admin-section"><h4>ğŸ—‘ï¸ Gestion des dÃ©chets</h4><textarea id="breitmatt_dechets"></textarea></div>
                        <div class="admin-section"><h4>ğŸ“ Contacts</h4><textarea id="breitmatt_contacts"></textarea></div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
                        <button class="admin-btn primary" onclick="saveAdminContent()">ğŸ’¾ Enregistrer</button>
                        <button class="admin-btn secondary" onclick="closeAdminModal()">Annuler</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="alert" id="alert"></div>
    
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">Envoi en cours...</div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
        const firebaseConfig = { databaseURL: "https://appli-controleur-gunder-default-rtdb.europe-west1.firebasedatabase.app" };
        const ADMIN_PASSWORD = "adminformulaire";
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.database(app);
        
        const DEFAULT_REGLEMENTS = {
            carpodrome: {
                horaires: "Sur rÃ©servation uniquement et 24h Ã  l'avance\n- Du 1er mars au 4 mai : samedis, dimanches et jours fÃ©riÃ©s\n- Du 5 mai au 30 octobre : tous les jours\n- PÃªche de 8h Ã  19h (dÃ©but mars Ã  fin avril et dÃ©but septembre Ã  fin octobre)\n- PÃªche de 8h Ã  20h (dÃ©but mai Ã  fin aoÃ»t)\nâš ï¸ L'AAPPMA se rÃ©serve le droit de fermer les Ã©tangs en cas d'Ã©vÃ©nement indÃ©pendant de sa volontÃ© (manque d'eau, cyanobactÃ©ries, etc...)",
                tarifs: "- Carte journaliÃ¨re : 10 â‚¬ / Titulaires carte annuelle AAPPMA : 5 â‚¬\n- Carte demi-journÃ©e : 6 â‚¬ / Titulaires carte annuelle AAPPMA : 3 â‚¬\n- Jours d'Ã©vÃ©nements : pÃªche payante pour tous (10 â‚¬)\n- RÃ©servation obligatoire 24h avant le jour de pÃªche via formulaire en ligne\n- Contact en cas de problÃ¨me : Patrice â€“ 06.37.70.37.31 ou gundershoffenaappma@gmail.com\nâš ï¸ Pour l'achat d'une carte journaliÃ¨re, merci de prÃ©voir le montant exact. L'association ne peut assurer la disponibilitÃ© de monnaie.",
                modalites: "- PÃªche No Kill obligatoire\n- Canne au coup uniquement, longueur max : 13 m\n- 1 ligne par pÃªcheur (pÃªcheur dÃ©signÃ© lors de la rÃ©servation)\n- Max 2 pÃªcheurs par poste (Ã  prÃ©ciser lors de la rÃ©servation)\n- PÃªche sous la canne, dans la zone du poste rÃ©servÃ©\n- AmorÃ§age : uniquement Ã  la coupelle ou fronde\n- MatÃ©riel obligatoire : bassine ou tapis de rÃ©ception Ã©pais avec rebord (5cm mini)\n- HameÃ§on taille max nÂº10 obligatoirement sans ardillon (pincÃ©/limÃ© interdit)\n- Bourriche autorisÃ©e pour poisson blanc uniquement\n- Carpes et tanches : relÃ¢chÃ©es immÃ©diatement\n- Esches autorisÃ©es : vÃ©gÃ©tales, vers de terre, asticots\n- Pellets et baby corn autorisÃ©s\n- Graines cuites uniquement\n- Kit de soins conseillÃ©",
                mineurs: "- Moins de 12 ans : accompagnement obligatoire d'une personne majeure et sous responsabilitÃ© parentale\n- AutorisÃ©e sans accompagnant Ã  partir de 12 ans",
                sanctions: "- Carte de pÃªche Ã  prÃ©senter\n- ContrÃ´les rÃ©guliers et imprÃ©vus\nSanctions :\n- 1Ã¨re infraction â†’ avertissement\n- 2Ã¨me infraction â†’ exclusion temporaire ou dÃ©finitive\n- Aucun remboursement du titre de pÃªche en cas d'exclusion",
                interdictions: "âŒ Feux au sol et barbecues\nâŒ PÃªche de nuit\nâŒ Camping (seuls parapluies autorisÃ©s)\nâŒ Baignade, canotage\nâŒ Mutilation ou marquage des poissons\nâŒ Faire pÃªcher une autre personne qui n'a pas rÃ©servÃ© le poste\nâŒ Franglaise, Feeder\nâŒ Poisson posÃ© au sol ou tenu avec un chiffon\nâŒ Graines crues\nâŒ PÃªche au pain\nâŒ HameÃ§ons avec ardillons\nâŒ PÃªche en surface",
                dechets: "- Le poste de pÃªche devra Ãªtre propre en fin de session\n- Vous devez emporter vos dÃ©chets sous peine d'une amende de 150â‚¬ (art. 632-1 du code pÃ©nal)",
                contacts: "- PrÃ©sident : RenÃ© Rahm â€“ 06.50.76.59.34\n- ProblÃ¨me sur rÃ©servations : Patrice Walter â€“ 06.37.70.37.31\n- Garde pÃªche : Raymond Ledig â€“ 06.95.24.90.84 (gpp67110@free.fr)\n- Urgences : POMPIERS 18 â€“ POLICE 17 â€“ SAMU 15\nğŸŒ www.aappma-gundershoffen.fr"
            },
            hardt: {
                horaires: "30 minutes avant le lever du soleil â†’ 30 minutes aprÃ¨s le coucher\n- Du 1er mars au 26 avril : samedis, dimanches et jours fÃ©riÃ©s uniquement\n- Du 5 mai au 30 octobre : tous les jours\n- Du 1er novembre au 31 dÃ©cembre : samedis, dimanches et jours fÃ©riÃ©s uniquement\n- PÃªche de nuit : 20h â†’ 8h (rÃ©servation obligatoire)\nPÃªche aux carnassiers autorisÃ©e :\n- Du 1er novembre au 31 dÃ©cembre, samedi, dimanche et jours fÃ©riÃ©s uniquement\n- Carte annuelle AAPPMA Gundershoffen obligatoire\n- Carte journaliÃ¨re refusÃ©e\nâš ï¸ L'AAPPMA se rÃ©serve le droit de fermer les Ã©tangs en cas d'Ã©vÃ©nement indÃ©pendant de sa volontÃ©",
                tarifs: "- Carte journaliÃ¨re : 10 â‚¬\n- Carte demi-journÃ©e : 6 â‚¬\n- Carte pÃªche de nuit : 10 â‚¬ (rÃ©servation 24h Ã  l'avance par SMS au 06.76.57.85.03)\n- Carte annuelle : obligatoire pour la pÃªche aux carnassiers\n- Jours d'Ã©vÃ©nements : pÃªche payante pour tous (10 â‚¬)\nâš ï¸ Pour l'achat d'une carte journaliÃ¨re, merci de prÃ©voir le montant exact",
                modalites: "- PÃªche No Kill obligatoire\n- AmorÃ§age et pÃªche depuis le poste\n- MatÃ©riel obligatoire : bassine ou tapis de rÃ©ception Ã©pais avec rebord (5cm mini) + filoche adaptÃ©e\n- Kit de soins conseillÃ©\n- Graines cuites uniquement\n- Esches autorisÃ©es : vÃ©gÃ©tales, vers, asticots, teignes, vers de luneâ€¦\n- Canne toujours sous surveillance\n- Respect des zones de pÃªche (voir plan) et des autres pÃªcheurs\n- 2 lignes maximum par pÃªcheur\n- 12 postes carpistes (nÂ°1 Ã  12)\n- 3 postes pÃªche au coup (lettres)\n- Poste 4 rÃ©servÃ© aux contrÃ´leurs\n- 1 vÃ©hicule par pÃªcheur autorisÃ© autour de l'Ã©tang\n- VÃ©hicules visiteurs Ã  stationner en dehors de l'enceinte\n- Circulation interdite aprÃ¨s 22h (sauf urgence aprÃ¨s avoir prÃ©venu un contrÃ´leur)",
                nuit: "Horaire : 20h jusqu'Ã  8h le lendemain\n- Sur rÃ©servation obligatoire 24h Ã  l'avance par SMS au 06.76.57.85.03\n- Une pÃªche de prÃ©sentation est obligatoire avant l'obtention d'une autorisation annuelle accordÃ©e par un des contrÃ´leurs dÃ©signÃ©s",
                mineurs: "- Moins de 12 ans : accompagnement obligatoire d'une personne majeure et sous responsabilitÃ© parentale\n- AutorisÃ©e sans accompagnant Ã  partir de 12 ans en journÃ©e uniquement\n- PÃªche de nuit autorisÃ©e uniquement en prÃ©sence continue d'une personne majeure et sous responsabilitÃ© parentale",
                sanctions: "- Il pourra vous Ãªtre demandÃ© de prÃ©senter votre titre de pÃªche lors des contrÃ´les\nSanctions :\n- 1Ã¨re infraction â†’ avertissement\n- 2Ã¨me infraction â†’ exclusion temporaire ou dÃ©finitive\n- Aucun remboursement du titre de pÃªche en cas d'exclusion",
                interdictions: "âŒ Feux au sol (barbecue lors des pÃ©riodes de sÃ©cheresse ou arrÃªtÃ©s prÃ©fectoraux)\nâŒ Consommation d'alcool excessive\nâŒ Camping (hors pÃªcheurs)\nâŒ Baignade, canotage, accÃ¨s aux Ã®les\nâŒ Mutilation ou marquage des poissons\nâŒ Canne laissÃ©e sans surveillance\nâŒ PÃªche en dehors des postes\nâŒ Sacs de conservation\nâŒ Bateau amorceur\nâŒ Poisson posÃ© au sol ou tenu avec un chiffon\nâŒ Graines crues\nâŒ PÃªche au pain\nâŒ HameÃ§ons avec ardillons\nâŒ Bas de ligne en tresse (sauf corps de ligne)\nâŒ PÃªche en surface\nâŒ Stationnement sur le chemin et ailleurs que derriÃ¨re son poste\nâŒ VÃ©hicules visiteurs autour de l'Ã©tang",
                carnassiers: "Interdictions spÃ©cifiques :\nâŒ Carte journaliÃ¨re (non autorisÃ©e)\nâŒ Filets, nasses, pÃªche Ã  la main ou sous glace\nâŒ Troubler l'eau, fouiller\nâŒ Utilisation de poissons protÃ©gÃ©s ou nuisibles (perche soleil, goujon asiatique...)\nâŒ AppÃ¢ts Ã  base d'Å“ufs de poissons\n- Quota : 3 carnassiers/jour max, dont 2 brochets (min. 50 cm)",
                dechets: "- Le poste de pÃªche devra Ãªtre propre en fin de session\n- Vous devez emporter vos dÃ©chets sous peine d'une amende de 150â‚¬ (art. 632-1 du code pÃ©nal)",
                contacts: "- PrÃ©sident : RenÃ© Rahm â€“ 06.50.76.59.34\n- Garde pÃªche : Raymond Ledig â€“ 06.95.24.90.84 (gpp67110@free.fr)\n- RÃ©servation pÃªche de nuit : Jean FranÃ§ois Klein â€“ 06.76.57.85.03\n- Urgences : POMPIERS 18 â€“ POLICE 17 â€“ SAMU 15\nğŸŒ www.aappma-gundershoffen.fr"
            },
            breitmatt: {
                horaires: "PÃªche possible uniquement dans le grand Ã©tang, sauf dÃ©rogation spÃ©cifique\n30 minutes avant le lever du soleil â†’ 30 minutes aprÃ¨s le coucher\n- Du 1er mars au 4 mai : samedis, dimanches et jours fÃ©riÃ©s uniquement\n- Du 5 mai au 30 octobre : tous les jours\n- Du 1er novembre au 31 dÃ©cembre : samedis, dimanches et jours fÃ©riÃ©s uniquement\nPÃªche aux carnassiers autorisÃ©e :\n- Du 1er novembre au 31 dÃ©cembre, samedi, dimanche et jours fÃ©riÃ©s uniquement\n- Carte annuelle AAPPMA Gundershoffen obligatoire\n- Carte journaliÃ¨re refusÃ©e\nâš ï¸ L'AAPPMA se rÃ©serve le droit de fermer les Ã©tangs en cas d'Ã©vÃ©nement indÃ©pendant de sa volontÃ©",
                tarifs: "- Carte journaliÃ¨re : 10 â‚¬\n- Carte demi-journÃ©e : 6 â‚¬\n- Carte annuelle : obligatoire pour la pÃªche aux carnassiers\n- Jours d'Ã©vÃ©nements : pÃªche payante pour tous (10 â‚¬)\nâš ï¸ Pour l'achat d'une carte journaliÃ¨re, merci de prÃ©voir le montant exact",
                modalites: "- PÃªche No Kill obligatoire (sauf truites et perches soleil)\n- AmorÃ§age et pÃªche depuis le poste obligatoire\n- MatÃ©riel obligatoire : bassine ou tapis de rÃ©ception Ã©pais avec rebord (5cm mini) + filoche adaptÃ©e\n- Kit de soins conseillÃ©\n- Graines cuites uniquement\n- Esches autorisÃ©es : vÃ©gÃ©tales, vers, asticots, teignes, vers de luneâ€¦\n- Canne toujours sous surveillance\n- Respect des zones de pÃªche et des autres pÃªcheurs\n- 2 lignes maximum par pÃªcheur",
                mineurs: "- Moins de 12 ans : accompagnement obligatoire d'une personne majeure et sous responsabilitÃ© parentale\n- AutorisÃ©e sans accompagnant Ã  partir de 12 ans, en journÃ©e uniquement",
                sanctions: "- Il pourra vous Ãªtre demandÃ© de prÃ©senter votre titre de pÃªche lors des contrÃ´les\nSanctions :\n- 1Ã¨re infraction â†’ avertissement\n- 2Ã¨me infraction â†’ exclusion temporaire ou dÃ©finitive\n- Aucun remboursement du titre de pÃªche en cas d'exclusion",
                interdictions: "âŒ Feux au sol et barbecues\nâŒ Camping (seuls parapluies ou demi-tentes autorisÃ©s)\nâŒ Baignade, canotage\nâŒ Mutilation ou marquage des poissons\nâŒ Canne laissÃ©e sans surveillance\nâŒ PÃªche en dehors des postes et dans la frayÃ¨re\nâŒ Sacs de conservation\nâŒ Bateau amorceur\nâŒ Poisson posÃ© au sol ou tenu avec un chiffon\nâŒ Graines crues\nâŒ PÃªche au pain\nâŒ HameÃ§ons avec ardillons\nâŒ Bas de ligne en tresse (sauf corps de ligne)\nâŒ PÃªche en surface\nâŒ Stationnement sur le chemin et la berge cÃ´tÃ© Ã©tang",
                carnassiers: "Interdictions spÃ©cifiques :\nâŒ Carte journaliÃ¨re (non autorisÃ©e)\nâŒ Filets, nasses, pÃªche Ã  la main ou sous glace\nâŒ Troubler l'eau, fouiller\nâŒ Utilisation de poissons protÃ©gÃ©s ou nuisibles (perche soleil, goujon asiatique...)\nâŒ AppÃ¢ts Ã  base d'Å“ufs de poissons\n- Quota : 3 carnassiers/jour max, dont 2 brochets (min. 50 cm)",
                dechets: "- Le poste de pÃªche devra Ãªtre propre en fin de session\n- Vous devez emporter vos dÃ©chets sous peine d'une amende de 150â‚¬ (art. 632-1 du code pÃ©nal)",
                contacts: "- PrÃ©sident : RenÃ© Rahm â€“ 06.50.76.59.34\n- Garde pÃªche : Raymond Ledig â€“ 06.95.24.90.84 (gpp67110@free.fr)\n- Urgences : POMPIERS 18 â€“ POLICE 17 â€“ SAMU 15\nğŸŒ www.aappma-gundershoffen.fr"
            }
        };
        
        let reglementsData = null;
        let currentReglement = null;
        let modalScrollComplete = false;
        const reglementsRead = { carpodrome: false, hardt: false, breitmatt: false };
        
        function loadReglementsFromFirebase() {
            db.ref('reglements_formulaire').on('value', (snapshot) => {
                reglementsData = snapshot.exists() ? snapshot.val() : null;
            });
        }
        loadReglementsFromFirebase();
        
        function getReglement(name) {
            return (reglementsData && reglementsData[name]) ? reglementsData[name] : DEFAULT_REGLEMENTS[name];
        }
        
        function formatSection(text, isInterdit = false) {
            if (!text) return '';
            let html = '', inList = false;
            text.split('\n').filter(l => l.trim()).forEach(line => {
                const t = line.trim();
                if (t.startsWith('-') || t.startsWith('âŒ')) {
                    if (!inList) { html += '<ul' + (isInterdit ? ' class="interdit"' : '') + '>'; inList = true; }
                    html += '<li>' + t.replace(/^-\s*/, '').replace(/^âŒ\s*/, 'âŒ ') + '</li>';
                } else if (t.startsWith('âš ï¸')) {
                    if (inList) { html += '</ul>'; inList = false; }
                    html += '<div class="important">' + t + '</div>';
                } else {
                    if (inList) { html += '</ul>'; inList = false; }
                    html += '<p>' + t + '</p>';
                }
            });
            return inList ? html + '</ul>' : html;
        }
        
        function generateReglementHTML(name) {
            const reg = getReglement(name);
            let html = '';
            if (name === 'carpodrome') {
                html += '<h3>ğŸ—“ï¸ PÃ‰RIODES ET HORAIRES</h3>' + formatSection(reg.horaires);
                html += '<h3>ğŸ« RÃ‰SERVATION ET TARIFS</h3>' + formatSection(reg.tarifs);
                html += '<h3>ğŸ£ MODALITÃ‰S DE PÃŠCHE</h3>' + formatSection(reg.modalites);
                html += '<h3>ğŸ‘¶ PÃŠCHE DES MINEURS</h3>' + formatSection(reg.mineurs);
                html += '<h3>ğŸ‘® CONTRÃ”LES ET SANCTIONS</h3>' + formatSection(reg.sanctions);
                html += '<h3>â›” INTERDICTIONS</h3>' + formatSection(reg.interdictions, true);
                html += '<h3>ğŸ—‘ï¸ GESTION DES DÃ‰CHETS</h3>' + formatSection(reg.dechets);
                html += '<div class="contact-box"><h3>ğŸ“ CONTACTS</h3>' + formatSection(reg.contacts) + '</div>';
            } else if (name === 'hardt') {
                html += '<h3>ğŸ—“ï¸ PÃ‰RIODES ET HORAIRES</h3>' + formatSection(reg.horaires);
                html += '<h3>ğŸ« CARTES ET TARIFS</h3>' + formatSection(reg.tarifs);
                html += '<h3>ğŸ£ MODALITÃ‰S DE PÃŠCHE</h3>' + formatSection(reg.modalites);
                html += '<h3>ğŸŒ™ PÃŠCHE DE NUIT</h3>' + formatSection(reg.nuit);
                html += '<h3>ğŸ‘¶ PÃŠCHE DES MINEURS</h3>' + formatSection(reg.mineurs);
                html += '<h3>ğŸ‘® CONTRÃ”LES ET SANCTIONS</h3>' + formatSection(reg.sanctions);
                html += '<h3>â›” INTERDICTIONS</h3>' + formatSection(reg.interdictions, true);
                html += '<h3>ğŸ¯ PÃŠCHE AUX CARNASSIERS</h3>' + formatSection(reg.carnassiers, true);
                html += '<h3>ğŸ—‘ï¸ GESTION DES DÃ‰CHETS</h3>' + formatSection(reg.dechets);
                html += '<div class="contact-box"><h3>ğŸ“ CONTACTS</h3>' + formatSection(reg.contacts) + '</div>';
            } else {
                html += '<h3>ğŸ—“ï¸ PÃ‰RIODES ET HORAIRES</h3>' + formatSection(reg.horaires);
                html += '<h3>ğŸ« CARTES ET TARIFS</h3>' + formatSection(reg.tarifs);
                html += '<h3>ğŸ£ MODALITÃ‰S DE PÃŠCHE</h3>' + formatSection(reg.modalites);
                html += '<h3>ğŸ‘¶ PÃŠCHE DES MINEURS</h3>' + formatSection(reg.mineurs);
                html += '<h3>ğŸ‘® CONTRÃ”LES ET SANCTIONS</h3>' + formatSection(reg.sanctions);
                html += '<h3>â›” INTERDICTIONS</h3>' + formatSection(reg.interdictions, true);
                html += '<h3>ğŸ¯ PÃŠCHE AUX CARNASSIERS</h3>' + formatSection(reg.carnassiers, true);
                html += '<h3>ğŸ—‘ï¸ GESTION DES DÃ‰CHETS</h3>' + formatSection(reg.dechets);
                html += '<div class="contact-box"><h3>ğŸ“ CONTACTS</h3>' + formatSection(reg.contacts) + '</div>';
            }
            html += '<div style="height:50px"></div><p style="text-align:center;font-weight:bold;color:#2e7d32">âœ… Vous avez lu l\'intÃ©gralitÃ© du rÃ¨glement</p><div style="height:20px"></div>';
            return html;
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('email')) {
                document.getElementById('email').value = params.get('email');
                document.getElementById('email').classList.add('prefilled');
                document.getElementById('prefillNotice').style.display = 'block';
            }
            if (params.get('nom')) document.getElementById('nom').value = params.get('nom');
            if (params.get('prenom')) document.getElementById('prenom').value = params.get('prenom');
        });
        
        document.querySelectorAll('.reglement-checkbox').forEach(cb => {
            cb.addEventListener('change', function() {
                const reg = this.closest('.reglement-item').dataset.reglement;
                const btn = document.querySelector(`.reglement-read-btn[data-for="${reg}"]`);
                const item = this.closest('.reglement-item');
                if (this.checked) { btn.disabled = false; item.classList.add('checked'); }
                else { btn.disabled = true; item.classList.remove('checked'); reglementsRead[reg] = false; updateReglementStatus(reg); }
                updateSubmitButton();
            });
        });
        
        document.querySelectorAll('.reglement-read-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                currentReglement = this.dataset.for;
                modalScrollComplete = false;
                const titles = { carpodrome: 'ğŸ£ RÃˆGLEMENT CARPODROME 2026', hardt: 'ğŸŸ RÃˆGLEMENT HARDT 2026', breitmatt: 'ğŸŒŠ RÃˆGLEMENT BREITMATT 2026' };
                document.getElementById('modalTitle').textContent = titles[currentReglement];
                document.getElementById('modalBody').innerHTML = generateReglementHTML(currentReglement);
                document.getElementById('modalBody').scrollTop = 0;
                document.getElementById('modalProgressBar').style.width = '0%';
                document.getElementById('modalProgressStatus').textContent = 'â¬‡ï¸ Faites dÃ©filer pour lire le rÃ¨glement complet';
                document.getElementById('modalProgressStatus').classList.remove('complete');
                document.getElementById('readConfirmCheckbox').checked = false;
                document.getElementById('readConfirmCheckbox').disabled = true;
                document.getElementById('readConfirmLabel').classList.add('disabled');
                document.getElementById('modalValidateBtn').disabled = true;
                document.getElementById('reglementModal').classList.add('visible');
            });
        });
        
        function checkModalScroll() {
            const mb = document.getElementById('modalBody');
            const pct = (mb.scrollTop / (mb.scrollHeight - mb.clientHeight)) * 100;
            document.getElementById('modalProgressBar').style.width = Math.min(pct, 100) + '%';
            if (pct >= 95 && !modalScrollComplete) {
                modalScrollComplete = true;
                document.getElementById('readConfirmCheckbox').disabled = false;
                document.getElementById('readConfirmLabel').classList.remove('disabled');
                document.getElementById('modalProgressStatus').textContent = 'âœ… RÃ¨glement lu - Cochez la case ci-dessous';
                document.getElementById('modalProgressStatus').classList.add('complete');
            }
        }
        
        function closeReglementModal() { document.getElementById('reglementModal').classList.remove('visible'); }
        document.getElementById('reglementModal').addEventListener('click', e => { if (e.target.id === 'reglementModal') closeReglementModal(); });
        document.getElementById('readConfirmCheckbox').addEventListener('change', function() { document.getElementById('modalValidateBtn').disabled = !this.checked; });
        document.getElementById('modalValidateBtn').addEventListener('click', () => {
            reglementsRead[currentReglement] = true;
            updateReglementStatus(currentReglement);
            closeReglementModal();
            updateSubmitButton();
            showAlert('âœ… RÃ¨glement ' + currentReglement.toUpperCase() + ' validÃ© !', 'success');
        });
        
        function updateReglementStatus(reg) {
            const s = document.getElementById('status-' + reg);
            if (reglementsRead[reg]) { s.textContent = 'âœ… Lu'; s.className = 'reglement-status read'; }
            else { s.textContent = 'Non lu'; s.className = 'reglement-status unread'; }
        }
        
        function updateSubmitButton() {
            const checked = document.querySelectorAll('.reglement-checkbox:checked');
            let allRead = true;
            checked.forEach(cb => { if (!reglementsRead[cb.closest('.reglement-item').dataset.reglement]) allRead = false; });
            document.getElementById('submitBtn').disabled = !(checked.length > 0 && allRead);
        }
        
        function openAdminModal() {
            document.getElementById('adminPasswordSection').style.display = 'block';
            document.getElementById('adminContentSection').style.display = 'none';
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminPasswordError').style.display = 'none';
            document.getElementById('adminModal').classList.add('visible');
            setTimeout(() => document.getElementById('adminPassword').focus(), 100);
        }
        function closeAdminModal() { document.getElementById('adminModal').classList.remove('visible'); }
        function checkAdminPassword() {
            if (document.getElementById('adminPassword').value === ADMIN_PASSWORD) {
                document.getElementById('adminPasswordSection').style.display = 'none';
                document.getElementById('adminContentSection').style.display = 'block';
                loadAdminContent();
            } else {
                document.getElementById('adminPasswordError').style.display = 'block';
                document.getElementById('adminPassword').value = '';
            }
        }
        function switchAdminTab(tab) {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
        }
        function loadAdminContent() {
            ['carpodrome', 'hardt', 'breitmatt'].forEach(name => {
                const reg = getReglement(name);
                Object.keys(reg).forEach(key => { const el = document.getElementById(name + '_' + key); if (el) el.value = reg[key] || ''; });
            });
        }
        function saveAdminContent() {
            const all = {
                carpodrome: { horaires: document.getElementById('carpodrome_horaires').value.trim(), tarifs: document.getElementById('carpodrome_tarifs').value.trim(), modalites: document.getElementById('carpodrome_modalites').value.trim(), mineurs: document.getElementById('carpodrome_mineurs').value.trim(), sanctions: document.getElementById('carpodrome_sanctions').value.trim(), interdictions: document.getElementById('carpodrome_interdictions').value.trim(), dechets: document.getElementById('carpodrome_dechets').value.trim(), contacts: document.getElementById('carpodrome_contacts').value.trim() },
                hardt: { horaires: document.getElementById('hardt_horaires').value.trim(), tarifs: document.getElementById('hardt_tarifs').value.trim(), modalites: document.getElementById('hardt_modalites').value.trim(), nuit: document.getElementById('hardt_nuit').value.trim(), mineurs: document.getElementById('hardt_mineurs').value.trim(), sanctions: document.getElementById('hardt_sanctions').value.trim(), interdictions: document.getElementById('hardt_interdictions').value.trim(), carnassiers: document.getElementById('hardt_carnassiers').value.trim(), dechets: document.getElementById('hardt_dechets').value.trim(), contacts: document.getElementById('hardt_contacts').value.trim() },
                breitmatt: { horaires: document.getElementById('breitmatt_horaires').value.trim(), tarifs: document.getElementById('breitmatt_tarifs').value.trim(), modalites: document.getElementById('breitmatt_modalites').value.trim(), mineurs: document.getElementById('breitmatt_mineurs').value.trim(), sanctions: document.getElementById('breitmatt_sanctions').value.trim(), interdictions: document.getElementById('breitmatt_interdictions').value.trim(), carnassiers: document.getElementById('breitmatt_carnassiers').value.trim(), dechets: document.getElementById('breitmatt_dechets').value.trim(), contacts: document.getElementById('breitmatt_contacts').value.trim() }
            };
            db.ref('reglements_formulaire').set(all).then(() => { closeAdminModal(); showAlert('âœ… RÃ¨glements enregistrÃ©s !', 'success'); }).catch(() => showAlert('âŒ Erreur', 'error'));
        }
        
        document.getElementById('codePostal').addEventListener('input', async function() {
            const cp = this.value.trim(), sel = document.getElementById('ville');
            if (cp.length === 5) {
                try {
                    const res = await fetch(`https://geo.api.gouv.fr/communes?codePostal=${cp}&fields=nom`);
                    const data = await res.json();
                    sel.innerHTML = '';
                    if (data.length) { data.forEach(v => { const o = document.createElement('option'); o.value = v.nom; o.textContent = v.nom; sel.appendChild(o); }); sel.disabled = false; }
                    else { sel.innerHTML = '<option value="">Aucune ville</option>'; sel.disabled = true; }
                } catch(e) { sel.innerHTML = '<option value="">Erreur</option>'; }
            } else { sel.innerHTML = '<option value="">Entrez le code postal</option>'; sel.disabled = true; }
        });
        
        document.getElementById('ficheForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const regs = [];
            document.querySelectorAll('.reglement-checkbox:checked').forEach(cb => { const r = cb.closest('.reglement-item').dataset.reglement; if (reglementsRead[r]) regs.push(r.toUpperCase()); });
            document.getElementById('loading').classList.add('visible');
            try {
                await db.ref('fiches').push({
                    nom: document.getElementById('nom').value.toUpperCase().trim(),
                    prenom: document.getElementById('prenom').value.trim(),
                    adresse: document.getElementById('adresse').value.trim(),
                    codePostal: document.getElementById('codePostal').value.trim(),
                    ville: document.getElementById('ville').value,
                    telephone: document.getElementById('telephone').value.trim(),
                    email: document.getElementById('email').value.trim(),
                    urgence: { nom: document.getElementById('urgenceNom').value.toUpperCase().trim(), prenom: document.getElementById('urgencePrenom').value.trim(), telephone: document.getElementById('urgenceTel').value.trim() },
                    reglements: regs,
                    date: new Date().toLocaleString('fr-FR'),
                    id: Date.now().toString(),
                    source: 'formulaire-public'
                });
                document.getElementById('loading').classList.remove('visible');
                document.getElementById('formPage').style.display = 'none';
                document.getElementById('successPage').classList.add('visible');
            } catch(e) { document.getElementById('loading').classList.remove('visible'); showAlert('âŒ Erreur', 'error'); }
        });
        
        function showAlert(msg, type) {
            const a = document.getElementById('alert');
            a.textContent = msg;
            a.className = 'alert alert-' + type + ' visible';
            setTimeout(() => a.classList.remove('visible'), 4000);
        }
    </script>
</body>
</html>
